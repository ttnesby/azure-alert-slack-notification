{
	order coraza_waf first
	order rate_limit before basicauth

	log {
		format console
		level info
	}
}

(to-slack) {
	az_alert_slack_notification
	reverse_proxy https://hooks.slack.com {
		header_up Host {upstream_hostport}
		rewrite {args[0]}
	}
}

http://localhost:8080 {
	encode zstd gzip

	route /slack/testvarsel* {
		import to-slack {$SLACK_TEST_NOTIFICATION}
	}

	route /slack/azureplatformalerts* {
		import to-slack {$SLACK_PROD_NOTIFICATION}
	}

	handle /health* {
		respond "I'm fine" 200
	}
}

# entry point for azure container app
http://localhost {
	# OWASP top 10 - web application firewall
	coraza_waf {
		load_owasp_crs
		directives `
		Include @coraza.conf-recommended
		Include @crs-setup.conf.example
		Include @owasp_crs/*.conf
		SecRuleEngine On
		`
	}

	# rate limit - maximum 120 events within 1 minute
	rate_limit {
		distributed
		zone static_example {
			key static
			events 120
			window 1m
		}
	}

	reverse_proxy http://localhost:8080
}
